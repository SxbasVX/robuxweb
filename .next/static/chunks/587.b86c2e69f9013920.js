"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[587,269],{8269:function(e,t,s){s.r(t),s.d(t,{default:function(){return i}});var a=s(7437),r=s(2265),l=s(1180);function i(e){let{groupId:t,currentUser:s,isEditMode:i,onToggleEdit:o,groupTopic:n}=e,[c,d]=(0,r.useState)(null),[u,m]=(0,r.useState)(!0),[x,p]=(0,r.useState)(!1),[g,h]=(0,r.useState)(null),[b,f]=(0,r.useState)(!1),[j,w]=(0,r.useState)(!1),[v,D]=(0,r.useState)(!1),[N,y]=(0,r.useState)({type:"text",title:"",content:""});(0,r.useEffect)(()=>{_()},[t]);let _=async()=>{try{let e=(0,l.S)(),{data:s,error:a}=await e.from("group_home_data").select("*").eq("group_id",t).single();if(a){console.log("No hay datos o tabla no existe, usando defaults:",a.message);let e={id:"temp_".concat(t),group_id:t,title:"Grupo ".concat(t),description:n,custom_sections:[{id:"welcome",type:"announcement",title:"\xa1Bienvenidos!",content:"Los delegados del grupo est\xe1n trabajando en personalizar esta p\xe1gina.",order:0}],theme_color:"#7C3AED",background_image:void 0,logo_image:void 0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};d(e);return}s&&d(s)}catch(e){console.error("Error in loadHomeData:",e),d({id:"fallback_".concat(t),group_id:t,title:"Grupo ".concat(t),description:n,custom_sections:[],theme_color:"#7C3AED",background_image:void 0,logo_image:void 0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})}finally{m(!1)}},C=async e=>{if(c){if(console.log("\uD83D\uDD04 Guardando cambios:",e),w(!0),c.id.startsWith("temp_")||c.id.startsWith("fallback_")){d({...c,...e,updated_at:new Date().toISOString()}),f(!1),D(!0),setTimeout(()=>D(!1),2e3),w(!1);return}try{let t=(0,l.S)(),{id:s,group_id:a,...r}=c,i={id:c.id.startsWith("temp_")||c.id.startsWith("fallback_")?"group_".concat(c.group_id):c.id,group_id:c.group_id,...r,...e,updated_at:new Date().toISOString()};console.log("\uD83D\uDCBE Datos a guardar en Supabase:",i);let{error:o}=await t.from("group_home_data").upsert(i,{onConflict:"group_id",ignoreDuplicates:!1});if(o)throw o;let n={...c,...e,id:i.id,updated_at:new Date().toISOString()};d(n),f(!1),D(!0),setTimeout(()=>D(!1),2e3)}catch(e){console.error("❌ Error al guardar:",e),alert("❌ Error al guardar los cambios: "+((null==e?void 0:e.message)||String(e)))}finally{w(!1)}}},S=(0,r.useCallback)(e=>{f(!0),g&&clearTimeout(g),h(setTimeout(()=>{C(e)},1e3))},[g,C]),k=async()=>{console.log("\uD83D\uDCBE Guardado manual iniciado"),g&&(clearTimeout(g),h(null)),c&&b?await C(c):console.log("⚠️ No hay cambios para guardar o homeData es null")},E=async(e,s)=>{if(!e)return null;p(!0);try{let a=(0,l.S)();if(e.size>5242880)throw Error("El archivo es demasiado grande. M\xe1ximo 5MB.");if(!["image/jpeg","image/jpg","image/png","image/webp","image/gif"].includes(e.type))throw Error("Tipo de archivo no v\xe1lido. Solo im\xe1genes (JPG, PNG, WebP, GIF).");let r="".concat(s,"_").concat(t,"_").concat(Date.now(),"_").concat(e.name.replace(/[^a-zA-Z0-9.-]/g,"_")),i="group-decoration/".concat(r),o="grupos",n=await a.storage.from(o).upload(i,e);if(n.error&&(console.log('❌ Error bucket "grupos", probando "public"'),o="public",(n=await a.storage.from(o).upload(i,e)).error))throw n.error;let{data:{publicUrl:c}}=a.storage.from(o).getPublicUrl(i);return c}catch(e){return console.error("❌ Error al subir imagen:",e),alert("❌ Error al subir la imagen: ".concat((null==e?void 0:e.message)||String(e))),null}finally{p(!1)}},T=async e=>{let t=await E(e,"background");t&&C({background_image:t})},F=async e=>{let t=await E(e,"logo");t&&C({logo_image:t})},G=async()=>{if(!c||!N.title.trim())return;let e={id:"section_".concat(Date.now()),type:N.type,title:N.title,content:N.content,order:c.custom_sections.length,image_url:void 0},t=[...c.custom_sections,e];await C({custom_sections:t}),y({type:"text",title:"",content:""})},A=async e=>{if(!c)return;let t=c.custom_sections.filter(t=>t.id!==e);await C({custom_sections:t})},I=async(e,t)=>{if(!c)return;let s=await E(t,"section");if(s){let t=c.custom_sections.map(t=>t.id===e?{...t,image_url:s}:t);await C({custom_sections:t})}},z=s&&("admin"===s.role||"delegado"===s.role&&s.group===t);return u?(0,a.jsx)("div",{className:"flex items-center justify-center p-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"})}):c?(0,a.jsxs)("div",{className:"space-y-6",children:[z&&(0,a.jsxs)("div",{className:"post-card p-4 space-y-3",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"w-3 h-3 rounded-full ".concat(i?"bg-red-500":"bg-green-500")}),(0,a.jsx)("span",{className:"text-white font-medium",children:i?"Modo Edici\xf3n Activo":"Modo Vista"}),b&&(0,a.jsx)("span",{className:"text-yellow-400 text-sm",children:"• Cambios sin guardar"})]}),(0,a.jsx)("div",{className:"flex items-center space-x-2",children:(0,a.jsx)("button",{onClick:o,className:"px-4 py-2 rounded-lg font-medium transition-colors ".concat(i?"bg-red-600 hover:bg-red-700 text-white":"bg-blue-600 hover:bg-blue-700 text-white"),children:i?"✅ Finalizar Edici\xf3n":"✏️ Editar P\xe1gina"})})]}),i&&(0,a.jsxs)("div",{className:"flex justify-between items-center pt-2 border-t",style:{borderColor:"var(--card-border)"},children:[(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsx)("button",{onClick:k,disabled:!b||j,className:"px-6 py-2 rounded-lg font-medium transition-all transform ".concat(b&&!j?"bg-green-600 hover:bg-green-700 text-white hover:scale-105 shadow-lg":"bg-gray-600 text-gray-400 cursor-not-allowed"),children:j?(0,a.jsxs)("span",{className:"flex items-center space-x-2",children:[(0,a.jsx)("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),(0,a.jsx)("span",{children:"Guardando..."})]}):(0,a.jsxs)("span",{className:"flex items-center space-x-2",children:[(0,a.jsx)("span",{children:"\uD83D\uDCBE"}),(0,a.jsx)("span",{children:"Guardar Cambios"})]})}),(0,a.jsx)("button",{className:"px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm",children:"\uD83D\uDD0D Debug"}),v&&(0,a.jsxs)("div",{className:"flex items-center space-x-2 text-green-400 animate-pulse",children:[(0,a.jsx)("span",{children:"✅"}),(0,a.jsx)("span",{className:"text-sm",children:"\xa1Guardado exitosamente!"})]})]}),(0,a.jsx)("div",{className:"text-xs text-gray-400",children:b?(0,a.jsx)("span",{children:"Los cambios se guardan autom\xe1ticamente"}):(0,a.jsx)("span",{children:"Todos los cambios est\xe1n guardados"})})]})]}),(0,a.jsxs)("div",{className:"relative rounded-xl overflow-hidden min-h-[400px] flex items-center justify-center post-card",style:{backgroundImage:c.background_image?"linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url(".concat(c.background_image,")"):"linear-gradient(135deg, ".concat(c.theme_color,"20, ").concat(c.theme_color,"40)"),backgroundSize:"cover",backgroundPosition:"center"},children:[(0,a.jsxs)("div",{className:"text-center z-10",children:[c.logo_image&&(0,a.jsx)("img",{src:c.logo_image,alt:"Logo del grupo",className:"mx-auto mb-6 h-24 w-24 object-cover rounded-full"}),i?(0,a.jsxs)("div",{className:"space-y-6 max-w-2xl mx-auto",children:[(0,a.jsxs)("div",{className:"post-card p-6",children:[(0,a.jsx)("label",{className:"block text-white text-sm font-medium mb-2",children:"\uD83D\uDCDD T\xedtulo del Grupo"}),(0,a.jsx)("input",{type:"text",value:c.title,onChange:e=>{let t=e.target.value;d({...c,title:t}),S({title:t})},className:"w-full text-2xl font-bold text-white bg-white/10 border-2 border-white/30 rounded-lg px-4 py-3 text-center placeholder-white/50 focus:border-white/70 focus:outline-none",placeholder:"Escribe el t\xedtulo de tu grupo..."})]}),(0,a.jsxs)("div",{className:"post-card p-6",children:[(0,a.jsx)("label",{className:"block text-white text-sm font-medium mb-2",children:"\uD83D\uDCD6 Descripci\xf3n del Grupo"}),(0,a.jsx)("textarea",{value:c.description,onChange:e=>{let t=e.target.value;d({...c,description:t}),S({description:t})},className:"w-full text-lg text-white bg-white/10 border-2 border-white/30 rounded-lg px-4 py-3 text-center placeholder-white/50 focus:border-white/70 focus:outline-none",placeholder:"Describe de qu\xe9 trata tu grupo...",rows:3})]})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h1",{className:"text-4xl font-bold text-white mb-4",children:c.title}),(0,a.jsx)("p",{className:"text-xl text-white/90 max-w-2xl",children:c.description})]})]}),i&&(0,a.jsx)("div",{className:"absolute top-4 right-4 flex flex-col space-y-2",children:(0,a.jsxs)("div",{className:"bg-black/40 backdrop-blur-sm rounded-lg p-3 border border-white/20",children:[(0,a.jsx)("p",{className:"text-white text-xs mb-2 text-center",children:"\uD83C\uDFA8 Personalizar"}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("label",{className:"flex items-center space-x-2 px-3 py-2 text-white text-sm rounded-lg cursor-pointer transition-colors ".concat(x?"bg-gray-600 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"),children:[x?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),(0,a.jsx)("span",{children:"Subiendo..."})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{children:"\uD83D\uDDBC️"}),(0,a.jsx)("span",{children:"Cambiar Fondo"})]}),(0,a.jsx)("input",{type:"file",accept:"image/*",disabled:x,onChange:e=>{var t;return(null===(t=e.target.files)||void 0===t?void 0:t[0])&&T(e.target.files[0])},className:"hidden"})]}),(0,a.jsxs)("label",{className:"flex items-center space-x-2 px-3 py-2 text-white text-sm rounded-lg cursor-pointer transition-colors ".concat(x?"bg-gray-600 cursor-not-allowed":"bg-green-600 hover:bg-green-700"),children:[x?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),(0,a.jsx)("span",{children:"Subiendo..."})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{children:"\uD83C\uDFF7️"}),(0,a.jsx)("span",{children:"Subir Logo"})]}),(0,a.jsx)("input",{type:"file",accept:"image/*",disabled:x,onChange:e=>{var t;return(null===(t=e.target.files)||void 0===t?void 0:t[0])&&F(e.target.files[0])},className:"hidden"})]})]})]})})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[c.custom_sections.sort((e,t)=>e.order-t.order).map(e=>(0,a.jsxs)("div",{className:"post-card p-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,a.jsx)("div",{className:"flex-1",children:i?(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"block text-white text-sm font-medium",children:"✏️ T\xedtulo de la Secci\xf3n"}),(0,a.jsx)("input",{type:"text",value:e.title,onChange:t=>{let s=c.custom_sections.map(s=>s.id===e.id?{...s,title:t.target.value}:s);d({...c,custom_sections:s}),S({custom_sections:s})},className:"w-full text-lg font-bold text-white bg-slate-700/50 border-2 border-slate-500 rounded-lg px-3 py-2 placeholder-slate-400 focus:border-blue-400 focus:outline-none",placeholder:"Escribe el t\xedtulo de la secci\xf3n..."})]}):(0,a.jsx)("h3",{className:"text-xl font-bold text-white",children:e.title})}),i&&(0,a.jsxs)("div",{className:"flex flex-col space-y-2 ml-4",children:[(0,a.jsxs)("label",{className:"flex items-center space-x-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg cursor-pointer transition-colors",children:[(0,a.jsx)("span",{children:"\uD83D\uDCF7"}),(0,a.jsx)("span",{children:"Imagen"}),(0,a.jsx)("input",{type:"file",accept:"image/*",onChange:t=>{var s;return(null===(s=t.target.files)||void 0===s?void 0:s[0])&&I(e.id,t.target.files[0])},className:"hidden"})]}),(0,a.jsxs)("button",{onClick:()=>A(e.id),className:"flex items-center space-x-1 px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-xs rounded-lg transition-colors",children:[(0,a.jsx)("span",{children:"\uD83D\uDDD1️"}),(0,a.jsx)("span",{children:"Eliminar"})]})]})]}),e.image_url&&(0,a.jsx)("div",{className:"section-image-wrapper",children:(0,a.jsx)("img",{src:e.image_url,alt:e.title,className:"section-image"})}),i?(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"block text-white text-sm font-medium",children:"\uD83D\uDCDD Contenido de la Secci\xf3n"}),(0,a.jsx)("textarea",{value:e.content,onChange:t=>{let s=c.custom_sections.map(s=>s.id===e.id?{...s,content:t.target.value}:s);d({...c,custom_sections:s}),S({custom_sections:s})},className:"w-full bg-slate-700/50 text-white rounded-lg p-3 border-2 border-slate-500 placeholder-slate-400 focus:border-blue-400 focus:outline-none",rows:4,placeholder:"Escribe el contenido de esta secci\xf3n..."}),(0,a.jsx)("p",{className:"text-xs text-slate-400",children:"\uD83D\uDCA1 Tip: Puedes usar saltos de l\xednea para organizar mejor tu contenido"})]}):(0,a.jsx)("p",{className:"text-gray-300 whitespace-pre-wrap",children:e.content})]},e.id)),i&&(0,a.jsxs)("div",{className:"post-card p-6 border-dashed",style:{borderWidth:2},children:[(0,a.jsxs)("div",{className:"flex items-center space-x-3 mb-6",children:[(0,a.jsx)("div",{className:"bg-blue-600 rounded-full p-2",children:(0,a.jsx)("span",{className:"text-xl",children:"➕"})}),(0,a.jsx)("h4",{className:"text-xl font-semibold text-white",children:"Agregar Nueva Secci\xf3n"})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-white text-sm font-medium mb-2",children:"✏️ T\xedtulo de la Nueva Secci\xf3n"}),(0,a.jsx)("input",{type:"text",value:N.title,onChange:e=>y({...N,title:e.target.value}),placeholder:"Ej: Bienvenida, Objetivos, Recursos...",className:"w-full bg-slate-700/70 text-white rounded-lg p-3 border-2 border-slate-500 placeholder-slate-400 focus:border-blue-400 focus:outline-none"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-white text-sm font-medium mb-2",children:"\uD83C\uDFA8 Tipo de Secci\xf3n"}),(0,a.jsxs)("select",{value:N.type,onChange:e=>y({...N,type:e.target.value}),className:"w-full bg-slate-700/70 text-white rounded-lg p-3 border-2 border-slate-500 focus:border-blue-400 focus:outline-none",children:[(0,a.jsx)("option",{value:"text",children:"\uD83D\uDCDD Texto Normal"}),(0,a.jsx)("option",{value:"announcement",children:"\uD83D\uDCE2 Anuncio Destacado"})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-white text-sm font-medium mb-2",children:"\uD83D\uDCDD Contenido Inicial (Opcional)"}),(0,a.jsx)("textarea",{value:N.content,onChange:e=>y({...N,content:e.target.value}),placeholder:"Escribe el contenido inicial para esta secci\xf3n...",className:"w-full bg-slate-700/70 text-white rounded-lg p-3 border-2 border-slate-500 placeholder-slate-400 focus:border-blue-400 focus:outline-none",rows:3})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center pt-2",children:[(0,a.jsx)("p",{className:"text-slate-400 text-sm",children:"\uD83D\uDCA1 Tip: Puedes editar y personalizar cada secci\xf3n despu\xe9s de crearla"}),(0,a.jsx)("button",{onClick:G,disabled:!N.title.trim(),className:"px-6 py-3 rounded-lg font-medium transition-all transform ".concat(N.title.trim()?"bg-green-600 hover:bg-green-700 text-white hover:scale-105 shadow-lg":"bg-gray-600 text-gray-400 cursor-not-allowed"),children:(0,a.jsxs)("span",{className:"flex items-center space-x-2",children:[(0,a.jsx)("span",{children:"✨"}),(0,a.jsx)("span",{children:"Crear Secci\xf3n"})]})})]})]})]})]}),x&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-slate-800 rounded-lg p-6 text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-white",children:"Subiendo imagen..."})]})})]}):(0,a.jsx)("div",{className:"post-card p-6",children:(0,a.jsx)("p",{className:"text-white",children:"No se pudo cargar la portada del grupo."})})}},9587:function(e,t,s){s.r(t),s.d(t,{default:function(){return o}});var a=s(7437),r=s(2265),l=s(3259),i=s(8269);function o(e){let{groupId:t,groupTopic:s,currentUser:o}=e,{user:n,role:c}=(0,l.a)(),[d,u]=(0,r.useState)(!1);return console.log("\uD83D\uDD0D GroupHomePage Debug:",{currentUser:o,userFromAuth:n,roleFromAuth:c,finalUser:o||n}),(0,a.jsx)(i.default,{groupId:t,currentUser:o||n,isEditMode:d,onToggleEdit:()=>{u(!d)},groupTopic:s})}}}]);